{
 "Description": "AWS CDK Infrastructure for Protex Wear E-commerce Platform",
 "Resources": {
  "ProtexWearInstance": {
   "Type": "AWS::Lightsail::Instance",
   "Properties": {
    "AvailabilityZone": "eu-west-1a",
    "BlueprintId": "wordpress",
    "BundleId": "nano_3_0",
    "InstanceName": "protex-wear-wordpress",
    "UserData": "#!/bin/bash\n\n# Protex Wear Infrastructure - User Data Script\n# Configuración automática: SWAP + Permisos Bitnami\n# Fecha: $(date)\n\n# Función de logging\nlog() {\n    echo \"[$(date '+%Y-%m-%d %H:%M:%S')] $1\" | tee -a /var/log/protex-wear-setup.log\n}\n\nlog \"=== INICIO: Configuración Protex Wear ===\"\n\n# 1. CONFIGURACIÓN SWAP (2GB) - CRÍTICO para evitar OOM kills\nlog \"Configurando SWAP de 2GB para prevenir OOM durante importación masiva...\"\n\n# Verificar si ya existe SWAP\nif swapon --show | grep -q \"/swapfile\"; then\n    log \"SWAP ya existe, omitiendo creación\"\nelse\n    log \"Creando archivo SWAP de 2GB...\"\n    fallocate -l 2G /swapfile\n    \n    if [ $? -eq 0 ]; then\n        log \"Archivo SWAP creado exitosamente\"\n        \n        # Configurar permisos de seguridad\n        chmod 600 /swapfile\n        log \"Permisos SWAP configurados (600)\"\n        \n        # Formatear como SWAP\n        mkswap /swapfile\n        log \"Archivo formateado como SWAP\"\n        \n        # Activar SWAP\n        swapon /swapfile\n        log \"SWAP activado\"\n        \n        # Hacer permanente en /etc/fstab\n        if ! grep -q \"/swapfile\" /etc/fstab; then\n            echo '/swapfile none swap sw 0 0' >> /etc/fstab\n            log \"SWAP añadido a /etc/fstab para persistencia\"\n        fi\n        \n        # Verificar SWAP activo\n        SWAP_SIZE=$(swapon --show --noheadings | awk '{print $3}')\n        log \"SWAP configurado correctamente: $SWAP_SIZE\"\n    else\n        log \"ERROR: Falló la creación del archivo SWAP\"\n    fi\nfi\n\n# 2. CONFIGURACIÓN PERMISOS BITNAMI - Mejores prácticas\nlog \"Configurando permisos Bitnami para wp-content...\"\n\nif [ -d \"/opt/bitnami/wordpress/wp-content\" ]; then\n    # Establecer propietario correcto\n    chown -R bitnami:daemon /opt/bitnami/wordpress/wp-content\n    log \"Propietario configurado: bitnami:daemon\"\n    \n    # Dar permisos de escritura al grupo\n    chmod -R g+w /opt/bitnami/wordpress/wp-content\n    log \"Permisos de grupo configurados: g+w\"\n    \n    # Verificar permisos\n    PERMS=$(ls -la /opt/bitnami/wordpress/ | grep wp-content)\n    log \"Permisos wp-content: $PERMS\"\nelse\n    log \"ADVERTENCIA: Directorio wp-content no encontrado, se configurará después\"\nfi\n\n# 3. VERIFICACIÓN FINAL\nlog \"=== VERIFICACIÓN FINAL ===\"\n\n# Verificar memoria total (RAM + SWAP)\nTOTAL_MEM=$(free -h | grep \"Mem:\" | awk '{print $2}')\nTOTAL_SWAP=$(free -h | grep \"Swap:\" | awk '{print $2}')\nlog \"Memoria RAM: $TOTAL_MEM\"\nlog \"Memoria SWAP: $TOTAL_SWAP\"\n\n# Verificar servicios Bitnami\nif systemctl is-active --quiet apache; then\n    log \"Servicio Apache: ACTIVO\"\nelif systemctl is-active --quiet nginx; then\n    log \"Servicio Nginx: ACTIVO\"\nelse\n    log \"ADVERTENCIA: Servicios web no detectados aún\"\nfi\n\nlog \"=== FIN: Configuración Protex Wear completada ===\"\nlog \"Logs disponibles en: /var/log/protex-wear-setup.log\"\n\n# Señal de finalización exitosa\ntouch /tmp/protex-wear-setup-complete\nlog \"Archivo de señal creado: /tmp/protex-wear-setup-complete\"\n"
   },
   "Metadata": {
    "aws:cdk:path": "ProtexWearInfraStack/ProtexWearInstance"
   }
  },
  "ProtexWearStaticIp": {
   "Type": "AWS::Lightsail::StaticIp",
   "Properties": {
    "AttachedTo": "protex-wear-wordpress",
    "StaticIpName": "protex-wear-static-ip"
   },
   "DependsOn": [
    "ProtexWearInstance"
   ],
   "Metadata": {
    "aws:cdk:path": "ProtexWearInfraStack/ProtexWearStaticIp"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/yXHMQ6DMAwAwLewJy4KLMxMTJXKA5AJoTWkLsIODIi/o4rpdA5cUUCe4S7WD7ON1MPRKvrZ4C5dpPdHBSnCUY/csCiyD6YeuVVU8s1y/vNMuiQ9Df+GAJM8NldCBXk2CZFdEyt9A7xuL6lNa4JyAAAA"
   },
   "Metadata": {
    "aws:cdk:path": "ProtexWearInfraStack/CDKMetadata/Default"
   }
  }
 },
 "Outputs": {
  "StaticIpAddress": {
   "Description": "IP estática para configurar Cloudflare DNS",
   "Value": {
    "Fn::GetAtt": [
     "ProtexWearStaticIp",
     "IpAddress"
    ]
   },
   "Export": {
    "Name": "ProtexWear-StaticIP"
   }
  },
  "WordPressUrl": {
   "Description": "URL de WordPress (usar HTTPS después de configurar Cloudflare)",
   "Value": {
    "Fn::Join": [
     "",
     [
      "http://",
      {
       "Fn::GetAtt": [
        "ProtexWearStaticIp",
        "IpAddress"
       ]
      }
     ]
    ]
   },
   "Export": {
    "Name": "ProtexWear-WordPressURL"
   }
  },
  "SSHCommand": {
   "Description": "Comando SSH para acceder a la instancia (reemplazar tu-clave.pem)",
   "Value": {
    "Fn::Join": [
     "",
     [
      "ssh -i tu-clave.pem bitnami@",
      {
       "Fn::GetAtt": [
        "ProtexWearStaticIp",
        "IpAddress"
       ]
      }
     ]
    ]
   },
   "Export": {
    "Name": "ProtexWear-SSHCommand"
   }
  },
  "CredentialsCommand": {
   "Description": "Comando para obtener credenciales de WordPress",
   "Value": {
    "Fn::Join": [
     "",
     [
      "ssh -i tu-clave.pem bitnami@",
      {
       "Fn::GetAtt": [
        "ProtexWearStaticIp",
        "IpAddress"
       ]
      },
      " \"cat /home/bitnami/bitnami_credentials\""
     ]
    ]
   },
   "Export": {
    "Name": "ProtexWear-CredentialsCommand"
   }
  },
  "NextSteps": {
   "Description": "Próximos pasos después del despliegue",
   "Value": {
    "Fn::Join": [
     "",
     [
      "1. Configurar DNS en Cloudflare: A @ -> ",
      {
       "Fn::GetAtt": [
        "ProtexWearStaticIp",
        "IpAddress"
       ]
      },
      " | 2. Obtener credenciales WordPress | 3. Acceder vía SSH para configuración adicional"
     ]
    ]
   },
   "Export": {
    "Name": "ProtexWear-NextSteps"
   }
  }
 },
 "Parameters": {
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}