{"version":"tree-0.1","tree":{"id":"App","path":"","constructInfo":{"fqn":"aws-cdk-lib.App","version":"2.233.0"},"children":{"ProtexWearInfraStack":{"id":"ProtexWearInfraStack","path":"ProtexWearInfraStack","constructInfo":{"fqn":"aws-cdk-lib.Stack","version":"2.233.0"},"children":{"ProtexWearInstance":{"id":"ProtexWearInstance","path":"ProtexWearInfraStack/ProtexWearInstance","constructInfo":{"fqn":"aws-cdk-lib.aws_lightsail.CfnInstance","version":"2.233.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Lightsail::Instance","aws:cdk:cloudformation:props":{"availabilityZone":"eu-west-1a","blueprintId":"wordpress","bundleId":"nano_3_0","instanceName":"protex-wear-wordpress","userData":"#!/bin/bash\n\n# Protex Wear Infrastructure - User Data Script\n# Configuración automática: SWAP + Permisos Bitnami\n# Fecha: $(date)\n\n# Función de logging\nlog() {\n    echo \"[$(date '+%Y-%m-%d %H:%M:%S')] $1\" | tee -a /var/log/protex-wear-setup.log\n}\n\nlog \"=== INICIO: Configuración Protex Wear ===\"\n\n# 1. CONFIGURACIÓN SWAP (2GB) - CRÍTICO para evitar OOM kills\nlog \"Configurando SWAP de 2GB para prevenir OOM durante importación masiva...\"\n\n# Verificar si ya existe SWAP\nif swapon --show | grep -q \"/swapfile\"; then\n    log \"SWAP ya existe, omitiendo creación\"\nelse\n    log \"Creando archivo SWAP de 2GB...\"\n    fallocate -l 2G /swapfile\n    \n    if [ $? -eq 0 ]; then\n        log \"Archivo SWAP creado exitosamente\"\n        \n        # Configurar permisos de seguridad\n        chmod 600 /swapfile\n        log \"Permisos SWAP configurados (600)\"\n        \n        # Formatear como SWAP\n        mkswap /swapfile\n        log \"Archivo formateado como SWAP\"\n        \n        # Activar SWAP\n        swapon /swapfile\n        log \"SWAP activado\"\n        \n        # Hacer permanente en /etc/fstab\n        if ! grep -q \"/swapfile\" /etc/fstab; then\n            echo '/swapfile none swap sw 0 0' >> /etc/fstab\n            log \"SWAP añadido a /etc/fstab para persistencia\"\n        fi\n        \n        # Verificar SWAP activo\n        SWAP_SIZE=$(swapon --show --noheadings | awk '{print $3}')\n        log \"SWAP configurado correctamente: $SWAP_SIZE\"\n    else\n        log \"ERROR: Falló la creación del archivo SWAP\"\n    fi\nfi\n\n# 2. CONFIGURACIÓN PERMISOS BITNAMI - Mejores prácticas\nlog \"Configurando permisos Bitnami para wp-content...\"\n\nif [ -d \"/opt/bitnami/wordpress/wp-content\" ]; then\n    # Establecer propietario correcto\n    chown -R bitnami:daemon /opt/bitnami/wordpress/wp-content\n    log \"Propietario configurado: bitnami:daemon\"\n    \n    # Dar permisos de escritura al grupo\n    chmod -R g+w /opt/bitnami/wordpress/wp-content\n    log \"Permisos de grupo configurados: g+w\"\n    \n    # Verificar permisos\n    PERMS=$(ls -la /opt/bitnami/wordpress/ | grep wp-content)\n    log \"Permisos wp-content: $PERMS\"\nelse\n    log \"ADVERTENCIA: Directorio wp-content no encontrado, se configurará después\"\nfi\n\n# 3. VERIFICACIÓN FINAL\nlog \"=== VERIFICACIÓN FINAL ===\"\n\n# Verificar memoria total (RAM + SWAP)\nTOTAL_MEM=$(free -h | grep \"Mem:\" | awk '{print $2}')\nTOTAL_SWAP=$(free -h | grep \"Swap:\" | awk '{print $2}')\nlog \"Memoria RAM: $TOTAL_MEM\"\nlog \"Memoria SWAP: $TOTAL_SWAP\"\n\n# Verificar servicios Bitnami\nif systemctl is-active --quiet apache; then\n    log \"Servicio Apache: ACTIVO\"\nelif systemctl is-active --quiet nginx; then\n    log \"Servicio Nginx: ACTIVO\"\nelse\n    log \"ADVERTENCIA: Servicios web no detectados aún\"\nfi\n\nlog \"=== FIN: Configuración Protex Wear completada ===\"\nlog \"Logs disponibles en: /var/log/protex-wear-setup.log\"\n\n# Señal de finalización exitosa\ntouch /tmp/protex-wear-setup-complete\nlog \"Archivo de señal creado: /tmp/protex-wear-setup-complete\"\n"}}},"ProtexWearStaticIp":{"id":"ProtexWearStaticIp","path":"ProtexWearInfraStack/ProtexWearStaticIp","constructInfo":{"fqn":"aws-cdk-lib.aws_lightsail.CfnStaticIp","version":"2.233.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Lightsail::StaticIp","aws:cdk:cloudformation:props":{"attachedTo":"protex-wear-wordpress","staticIpName":"protex-wear-static-ip"}}},"StaticIpAddress":{"id":"StaticIpAddress","path":"ProtexWearInfraStack/StaticIpAddress","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.233.0"}},"WordPressUrl":{"id":"WordPressUrl","path":"ProtexWearInfraStack/WordPressUrl","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.233.0"}},"SSHCommand":{"id":"SSHCommand","path":"ProtexWearInfraStack/SSHCommand","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.233.0"}},"CredentialsCommand":{"id":"CredentialsCommand","path":"ProtexWearInfraStack/CredentialsCommand","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.233.0"}},"NextSteps":{"id":"NextSteps","path":"ProtexWearInfraStack/NextSteps","constructInfo":{"fqn":"aws-cdk-lib.CfnOutput","version":"2.233.0"}},"CDKMetadata":{"id":"CDKMetadata","path":"ProtexWearInfraStack/CDKMetadata","constructInfo":{"fqn":"constructs.Construct","version":"10.4.4"},"children":{"Default":{"id":"Default","path":"ProtexWearInfraStack/CDKMetadata/Default","constructInfo":{"fqn":"aws-cdk-lib.CfnResource","version":"2.233.0"}}}},"BootstrapVersion":{"id":"BootstrapVersion","path":"ProtexWearInfraStack/BootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnParameter","version":"2.233.0"}},"CheckBootstrapVersion":{"id":"CheckBootstrapVersion","path":"ProtexWearInfraStack/CheckBootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnRule","version":"2.233.0"}}}},"Tree":{"id":"Tree","path":"Tree","constructInfo":{"fqn":"constructs.Construct","version":"10.4.4"}}}}}